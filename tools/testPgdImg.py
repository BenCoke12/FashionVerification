import re
import numpy as np
import onnxruntime as ort
import ast
#import tensorflow as tf
#from tensorflow import keras
import idx2numpy

def testPgdImg(index, epsilon, pgd_img):
    #original image and label (index 104 of the test set)
    original_image = idx2numpy.convert_from_file('../idxdata/individuals/Image' + str(index) + '.idx')[0]
    original_label = idx2numpy.convert_from_file('../idxdata/individuals/Label' + str(index) + '.idx')[0]

    #Check it is a valid image
    criterion = (pgd_img <= 1) & (pgd_img >= 0)
    print("Valid image criterion satisfied on all pixels: ", criterion.all())

    #check it is epsilon distance from the original image
    print("Within epsilon distance: ", np.allclose(original_image, pgd_img, rtol=0, atol=epsilon + 0.00001))

    #Check a robustness counterexample causes a missclassification
    #ort
    ortSession = ort.InferenceSession("../onnxnetworks/fashion1l32n.onnx")

    #original image classified label
    image = np.array([np.array(row) for row in original_image])
    imageForRuntime = image.astype(np.float32)
    imageReshape = np.array([imageForRuntime])
    ort_inputs = {ortSession.get_inputs()[0].name: imageReshape}
    original_image_prediction = ortSession.run(None, ort_inputs)

    #counterexample classified label
    image = np.array([np.array(row) for row in pgd_img])
    imageForRuntime = image.astype(np.float32)
    imageReshape = np.array([imageForRuntime])
    ort_inputs = {ortSession.get_inputs()[0].name: imageReshape}
    counterexample_prediction = ortSession.run(None, ort_inputs)

    print("Original image predicted label: ", np.argmax(original_image_prediction))
    print("Counterexample predicted label: ", np.argmax(counterexample_prediction))
    print("True Label: ", original_label)

    #assert(original label == classified label)
    np.testing.assert_allclose(original_image, pgd_img, rtol=0, atol=epsilon+0.00001)


#pgd images
#i=43, eps=0.01
pgd_img1 = np.array([[0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.0], [0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0], [0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01], [0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.0], [0.01, 0.01, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01], [0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01392156862745098, 0.01, 0.01, 0.8409803921568627, 0.4684313725490196, 0.02137254901960784, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01], [0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.021764705882352943, 0.01, 0.21000000000000002, 0.9154901960784314, 0.8919607843137255, 0.99, 0.798235294117647, 0.5315686274509804, 0.213921568627451, 0.01, 0.01, 0.01, 0.01, 0.01], [0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.817843137254902, 0.8213725490196079, 0.8174509803921568, 0.8723529411764706, 0.9315686274509803, 0.9550980392156863, 0.9550980392156863, 0.8531372549019608, 0.6884313725490196, 0.3315686274509804, 0.01, 0.01], [0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.025686274509803923, 0.01, 0.01, 0.9550980392156863, 0.8605882352941177, 0.8723529411764706, 0.8645098039215686, 0.8570588235294118, 0.8649019607843137, 0.8488235294117646, 0.8805882352941177, 0.9982352941176471, 0.7864705882352941, 0.01, 0.01], [0.01, 0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.17862745098039218, 0.33509803921568626, 0.9547058823529412, 0.8370588235294117, 0.8845098039215686, 0.8923529411764706, 0.8884313725490196, 0.8845098039215686, 0.8688235294117647, 0.9080392156862745, 0.817843137254902, 0.01, 0.01], [0.01, 0.0, 0.0, 0.0, 0.01, 0.0, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.7354901960784314, 1.0, 0.8605882352941177, 0.8449019607843137, 0.8962745098039215, 0.8884313725490196, 0.8845098039215686, 0.8923529411764706, 0.8492156862745098, 0.9354901960784314, 0.8609803921568627, 0.01, 0.01], [0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.38254901960784315, 0.5550980392156862, 0.8449019607843137, 0.8645098039215686, 0.8605882352941177, 0.8845098039215686, 0.8766666666666667, 0.8845098039215686, 0.8805882352941177, 0.8766666666666667, 0.8998039215686274, 0.8958823529411765, 0.0, 0.0], [0.01, 0.01, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.013529411764705882, 0.013529411764705882, 0.0, 0.01, 0.01, 0.406078431372549, 0.99, 0.8723529411764706, 0.8688235294117647, 0.8845098039215686, 0.8645098039215686, 0.8884313725490196, 0.9001960784313725, 0.8766666666666667, 0.8370588235294117, 0.8845098039215686, 0.99, 0.0, 0.0], [0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.009607843137254901, 0.0, 0.0, 0.021764705882352943, 0.0, 0.813921568627451, 0.8609803921568627, 0.8609803921568627, 0.8688235294117647, 0.8923529411764706, 0.8766666666666667, 0.8605882352941177, 0.8645098039215686, 0.8605882352941177, 0.8570588235294118, 0.9001960784313725, 0.8527450980392157, 0.9625490196078431, 0.3390196078431372, 0.0], [0.0, 0.0, 0.01, 0.01392156862745098, 0.017843137254901963, 0.0017647058823529408, 0.0, 0.0, 0.0, 0.0488235294117647, 0.11941176470588237, 0.24882352941176472, 0.8880392156862745, 0.6452941176470588, 0.8727450980392157, 0.8684313725490196, 0.8566666666666667, 0.8605882352941177, 0.8845098039215686, 0.8845098039215686, 0.8884313725490196, 0.9001960784313725, 0.9115686274509803, 0.8801960784313725, 0.786078431372549, 0.8409803921568627, 0.8723529411764706, 0.0], [0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.32725490196078433, 0.46058823529411763, 0.99, 0.5978431372549019, 0.9786274509803922, 0.786078431372549, 0.7311764705882353, 0.8688235294117647, 0.9041176470588236, 0.8684313725490196, 0.8962745098039215, 0.8962745098039215, 0.8919607843137255, 0.9037254901960784, 0.7703921568627451, 0.6213725490196078, 0.6527450980392157, 0.7664705882352941, 1.0, 0.11196078431372548], [0.0, 0.01, 0.01, 0.01, 0.1943137254901961, 0.39784313725490195, 0.8174509803921568, 0.7154901960784313, 0.8527450980392157, 0.8684313725490196, 0.8213725490196079, 0.9037254901960784, 0.8684313725490196, 0.7668627450980392, 0.7903921568627451, 0.797843137254902, 0.8801960784313725, 0.8566666666666667, 0.8845098039215686, 0.9119607843137255, 0.8527450980392157, 0.7276470588235294, 0.6645098039215687, 0.6331372549019608, 0.6645098039215687, 0.7625490196078432, 1.0, 0.029607843137254904], [0.03313725490196078, 0.7272549019607844, 0.7511764705882353, 0.8492156862745098, 0.9080392156862745, 0.9233333333333333, 0.8841176470588236, 0.8880392156862745, 0.8527450980392157, 0.8449019607843137, 0.8762745098039215, 0.8174509803921568, 0.8762745098039215, 0.8374509803921568, 0.7707843137254902, 0.798235294117647, 0.8566666666666667, 0.9037254901960784, 0.8884313725490196, 0.9119607843137255, 0.8256862745098039, 0.7233333333333333, 0.7429411764705882, 0.6880392156862745, 0.6566666666666666, 0.7433333333333333, 0.8845098039215686, 0.43745098039215685], [0.7507843137254901, 0.8845098039215686, 0.817843137254902, 0.8570588235294118, 0.8492156862745098, 0.8370588235294117, 0.8488235294117646, 0.8409803921568627, 0.8723529411764706, 0.8723529411764706, 0.8762745098039215, 0.8762745098039215, 0.9041176470588236, 0.8449019607843137, 0.7668627450980392, 0.7472549019607844, 0.802156862745098, 0.8649019607843137, 0.8449019607843137, 0.8488235294117646, 0.817843137254902, 0.8256862745098039, 0.8096078431372549, 0.8296078431372549, 0.8174509803921568, 0.8570588235294118, 0.9154901960784314, 0.35470588235294115], [0.47627450980392155, 0.7664705882352941, 0.806078431372549, 0.7511764705882353, 0.7315686274509804, 0.7550980392156863, 0.79, 0.813921568627451, 0.8256862745098039, 0.8413725490196079, 0.8335294117647059, 0.8492156862745098, 0.8413725490196079, 0.8452941176470589, 0.8335294117647059, 0.8292156862745098, 0.8801960784313725, 0.9076470588235294, 0.99, 0.9782352941176471, 0.9825490196078431, 0.8923529411764706, 0.8174509803921568, 0.7668627450980392, 0.6492156862745098, 0.5198039215686274, 0.3276470588235294, 0.0], [0.0, 0.06490196078431372, 0.40215686274509804, 0.7315686274509804, 0.8449019607843137, 0.8723529411764706, 0.9115686274509803, 0.8527450980392157, 0.8880392156862745, 0.8841176470588236, 0.9080392156862745, 0.9119607843137255, 0.9041176470588236, 1.0, 1.0, 0.8723529411764706, 0.6370588235294118, 0.3743137254901961, 0.10372549019607843, 0.02137254901960784, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01392156862745098, 0.0], [0.01, 0.01, 0.01, 0.01, 0.0017647058823529408, 0.08803921568627451, 0.2449019607843137, 0.35862745098039217, 0.40215686274509804, 0.41784313725490196, 0.42176470588235293, 0.3276470588235294, 0.20607843137254903, 0.10019607843137254, 0.01, 0.0, 0.0, 0.0, 0.0, 0.01745098039215686, 0.025686274509803923, 0.07666666666666666, 0.08450980392156862, 0.1080392156862745, 0.12372549019607842, 0.16294117647058826, 0.12372549019607842, 0.0], [0.01, 0.01, 0.01392156862745098, 0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.021764705882352943, 0.03313725490196078, 0.04098039215686274, 0.04490196078431372, 0.03313725490196078, 0.0292156862745098, 0.045294117647058825, 0.049215686274509805, 0.029607843137254904, 0.025686274509803923, 0.017843137254901963, 0.017843137254901963, 0.01, 0.01], [0.01, 0.0, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01], [0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.0, 0.01], [0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.0, 0.0, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.01, 0.01, 0.01, 0.0, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.01, 0.01, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.0, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.0, 0.0, 0.01]])
testPgdImg(43, 0.01, pgd_img1)